<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alumni Connect Platform</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Dark Mode Styles */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode a {
      color: #9ad1ff;
    }
    body.dark-mode .navbar {
      background-color: #1f1f1f !important;
    }
    body.dark-mode input,
    body.dark-mode textarea {
      background-color: #1f1f1f;
      color: #e0e0e0;
      border-color: #333;
    }
    body.dark-mode .bg-white {
      background-color: #1f1f1f !important;
    }
    
    body.dark-mode #home {
      background-color: #2d3748;
    }
    body.dark-mode #home h2, body.dark-mode #home p {
      color: #e0e0e0;
    }

    /* Section Backgrounds for Dark Mode */
    body.dark-mode #directory { background-color: #1a1a1a; }
    body.dark-mode #events { background-color: #222222; }
    body.dark-mode #donations { background-color: #1a1a1a; }

    /* Smooth Transitions Globally */
    * {
      transition: all 0.3s ease;
    }

    /* Card Hover Effect */
    .shadow-lg:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }
    body.dark-mode .shadow-lg:hover {
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
    }

    /* Scroll animations */
    .fade-in {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.8s ease-out, transform 0.8s ease-out;
    }
    .fade-in.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Text Animations for headings */
    h3 {
      position: relative;
      overflow: hidden;
    }
    h3::after {
      content: '';
      position: absolute;
      width: 0;
      height: 3px;
      bottom: 0;
      left: 0;
      background-color: #4f46e5;
      transition: width 0.5s ease;
    }
    h3:hover::after {
      width: 100%;
    }

    /* Improved Input Focus */
    input:focus,
    textarea:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 5px rgba(79, 70, 229, 0.5);
    }

    /* --- ✨ FINALIZED FUTURISTIC ANIMATION ✨ --- */
    #hero-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 85vh;
      overflow: hidden;
      position: relative;
    }

    @media (min-width: 768px) {
      #hero-container { flex-direction: row; }
    }

    #hero-text-content { z-index: 10; }

    #animated-logo-container {
      position: relative;
      perspective: 1500px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #company-logo {
      width: 100%;
      max-width: 350px;
      height: auto;
      opacity: 0;
      transform: rotateY(-45deg) scale(0.5);
      animation: holographic-reveal 3s forwards 0.5s;
    }

    #animated-logo-container::before {
      content: '';
      position: absolute;
      bottom: 40px;
      width: 400px;
      height: 80px;
      background: radial-gradient(ellipse at center, rgba(79, 70, 229, 0.4) 0%, rgba(79, 70, 229, 0) 70%);
      border-radius: 50%;
      transform: rotateX(80deg);
      animation: projector-glow 4s infinite alternate;
    }
    
    #animated-logo-container::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: #93c5fd;
      border-radius: 2px;
      box-shadow: 0 0 10px #93c5fd, 0 0 20px white;
      animation: scan-lines 4s cubic-bezier(0.23, 1, 0.32, 1) infinite;
      animation-delay: 3.5s;
    }

    @keyframes holographic-reveal {
      0% { opacity: 0; filter: blur(20px); transform: rotateY(-45deg) scale(0.5) translateY(100px); }
      50% { opacity: 0.8; filter: blur(8px); }
      100% { opacity: 1; filter: blur(0); transform: rotateY(0deg) scale(1) translateY(0); }
    }
    
    @keyframes projector-glow {
      from { opacity: 0.6; transform: rotateX(80deg) scale(0.9); }
      to { opacity: 1; transform: rotateX(80deg) scale(1.1); }
    }
    
    @keyframes scan-lines {
      0% { transform: translateY(0); opacity: 0; }
      5% { opacity: 1; }
      95% { opacity: 1; }
      100% { transform: translateY(350px); opacity: 0; }
    }

    /* ADDED: hide the directory grid by default to prevent mass exposure of alumni */
    #directory .grid {
      display: none; /* Hidden until a search is made */
    }

    /* small helper for messages */
    .chat-container { height: 400px; overflow-y: auto; }
    .message { padding: 0.5rem 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; display: inline-block; max-width: 85%; }
    .message.me { background-color: #e0f2fe; align-self: flex-end; }
    .message.them { background-color: #f1f5f9; align-self: flex-start; }

    /* ADDED: Styles for redesigned components */
    .forum-tab {
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      color: #6b7280; /* text-gray-500 */
      font-weight: 600;
      transition: all 0.2s ease-in-out;
    }
    .forum-tab:hover {
      color: #111827; /* text-gray-900 */
      border-bottom-color: #d1d5db; /* border-gray-300 */
    }
    .forum-tab.active {
      color: #4f46e5; /* theme-color */
      border-bottom-color: #4f46e5;
    }
    body.dark-mode .forum-tab {
        color: #9ca3af; /* dark:text-gray-400 */
    }
    body.dark-mode .forum-tab:hover {
        color: #f9fafb; /* dark:text-gray-50 */
        border-bottom-color: #4b5563; /* dark:border-gray-600 */
    }
    body.dark-mode .forum-tab.active {
        color: #818cf8; /* dark:theme-color */
        border-bottom-color: #818cf8;
    }

    body.dark-mode .message.me { background-color: #2563eb; color: white; }
    body.dark-mode .message.them { background-color: #374151; }
    .message { transition: transform 0.2s ease-out; }

    #chatModal.visible #chat-modal-content {
        transform: scale(1);
        opacity: 1;
    }

    .chat-user-item-list {
        padding: 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .chat-user-item-list:hover {
        background-color: #f3f4f6;
    }
    body.dark-mode .chat-user-item-list:hover {
        background-color: #374151;
    }

    /* Redesigned message bubbles */
    .message { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 75%; line-height: 1.4; word-wrap: break-word; }
    .message.me { background-color: #dbeafe; color: #1e40af; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
    .message.them { background-color: #f3f4f6; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 0.25rem; }

    /* ADDED: Styles for the new slide-in chat panel */
    #chat-panel-container {
        transition: opacity 0.3s ease-in-out;
    }
    #chat-panel {
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
    }
    #chat-panel-container.visible {
        opacity: 1;
        pointer-events: auto;
    }
    #chat-panel-container.visible #chat-panel {
        transform: translateX(0);
    }

    /* ADDED: Styles for the new Alumni Showcase */
    #alumni-showcase {
      background-color: #f9fafb; /* bg-gray-50 */
    }
    body.dark-mode #alumni-showcase {
        background-color: #1a1a1a;
    }
    .showcase-container {
      width: 100%;
      overflow: hidden;
      -webkit-mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
      mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
    }
    .showcase-slider {
      display: flex;
      width: fit-content;
      animation: infinite-scroll 35s linear infinite;
    }
    .alumni-card {
      width: 350px;
      flex-shrink: 0;
    }
    @keyframes infinite-scroll {
      from { transform: translateX(0); }
      to { transform: translateX(-50%); } /* Slides by half the width (since we duplicate the content) */
    }
    .showcase-slider:hover {
      animation-play-state: paused;
    }


  </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-300">

  <nav class="navbar flex items-center justify-between p-4 bg-blue-600 text-white shadow-md sticky top-0 z-50">
    <h1 class="text-2xl font-bold">Alumni Connect</h1>
    <div class="space-x-6 hidden md:flex">
      <a href="#home" class="hover:underline">Home</a>
      <a href="#alumni" class="hover:underline">Alumni</a>
      <a href="#directory" class="hover:underline">Directory</a>
      <a href="#networking" class="hover:underline">Networking</a>
      <a href="#events" class="hover:underline">Events</a>
      <a href="#mentorship" class="hover:underline">Mentorship</a>
      <a href="#donations" class="hover:underline">Donations</a>
    </div>

    <div class="flex items-center gap-4">
      <div id="auth-status" class="text-sm hidden md:block">Not signed in</div>
      <button id="openAuthBtn" class="px-3 py-1 bg-white text-blue-600 rounded hover:opacity-90">Sign up / Log in</button>
      <button id="darkModeToggle" class="px-4 py-2 bg-gray-900 rounded-lg hover:bg-gray-700 text-sm">
        🌙 Dark Mode
      </button>
    </div>
  </nav>

  <section id="home" class="bg-gray-200 text-gray-800 fade-in">
    <div id="hero-container" class="max-w-7xl mx-auto px-6">
      <div id="hero-text-content" class="text-center md:text-left md:w-1/2 md:pr-12">
        <h2 class="text-4xl lg:text-5xl font-bold mb-4">Stay Connected. Empower the Future.</h2>
        <p class="text-lg mb-6">Centralized alumni management with networking, mentorship, events, and career support.</p>
        <a href="#alumni" class="inline-block px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transform hover:scale-105">
          Get Started
        </a>
      </div>
      <div id="animated-logo-container" class="w-full md:w-1/2 md:mt-0">
        <img src="https://placehold.co/350x350/transparent/4f46e5?text=AC&font=inter" alt="Company Logo" id="company-logo" />
      </div>
    </div>
  </section>

  <!-- ADDED: Alumni Showcase Section -->
  <section id="alumni-showcase" class="py-12 fade-in">
    <div class="max-w-7xl mx-auto text-center px-6">
        <h3 class="text-3xl font-bold mb-2">Our Esteemed Alumni</h3>
        <p class="text-gray-600 mb-8 max-w-2xl mx-auto">Discover the paths of excellence forged by our graduates. Their journeys inspire our future.</p>
    </div>
    <div class="showcase-container">
        <div id="showcase-slider-content" class="showcase-slider">
            <!-- Alumni cards will be injected here by JavaScript -->
        </div>
    </div>
  </section>


  <section id="alumni" class="max-w-5xl mx-auto py-12 px-6 fade-in">
    <h3 class="text-2xl font-bold mb-6 border-b pb-2">Alumni Registration & Profiles</h3>
    <form id="alumni-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-6 rounded-xl shadow-lg">
      <input type="text" id="alumni-name" placeholder="Full Name" class="p-3 border rounded" />
      <input type="email" id="alumni-email" placeholder="Email (Mandatory)" class="p-3 border rounded" />
      <input type="text" id="alumni-batch" placeholder="Batch" class="p-3 border rounded" />
      <input type="text" id="alumni-dept" placeholder="Department" class="p-3 border rounded" />
      <input type="text" id="alumni-role" placeholder="Current Job Title" class="p-3 border rounded" />
      <input type="text" id="alumni-company" placeholder="Company" class="p-3 border rounded" />
      <input type="text" id="alumni-location" placeholder="Location (e.g., City, Country)" class="p-3 border rounded" />
      <input type="file" class="p-3 border rounded col-span-2" accept="image/*" />
      <button class="col-span-2 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Register</button>
    </form>
  </section>

  <section id="directory" class="bg-gray-100 py-12 px-6 fade-in">
    <div class="max-w-5xl mx-auto">
      <h3 class="text-2xl font-bold mb-6 border-b pb-2">Centralized Alumni Directory</h3>

      <input type="text" placeholder="Search alumni by name, batch, department..." class="w-full p-3 border rounded mb-6" />

      <div class="flex items-center gap-3 mb-4">
        <button id="directorySearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Search</button>
        <button id="clearSearchBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Clear</button>
        <div class="text-sm text-gray-600 ml-4">Only search results are shown — all alumni data is private by default.</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Search results will be injected here by JavaScript -->
      </div>
    </div>
  </section>

  <section id="networking" class="max-w-5xl mx-auto py-12 px-6 fade-in">
    <h3 class="text-2xl font-bold mb-6 border-b pb-2">Communication & Networking</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

      <!-- Redesigned Messaging Card -->
      <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col">
        <h4 class="font-semibold text-lg">Messaging System</h4>
        <p class="text-sm mt-2 flex-grow">Connect with peers and mentors through a secure, real-time private messaging system.</p>
        <button id="openChatModalBtn" class="mt-4 w-full bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd" /></svg>
          Launch Messenger
        </button>
      </div>

      <!-- Redesigned Discussion Forums Card -->
      <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col">
        <h4 class="font-semibold text-lg mb-4">Discussion Forums</h4>
        
        <!-- Forum Navigation Tabs -->
        <div id="forumList" class="flex border-b border-gray-200 mb-4">
          <button class="forum-tab active" data-forum="general">General</button>
          <button class="forum-tab" data-forum="jobs">Jobs & Careers</button>
          <button class="forum-tab" data-forum="reunions">Reunions</button>
        </div>

        <!-- Threads Container -->
        <div id="forumThreads" class="flex-grow space-y-3 overflow-y-auto" style="max-height: 250px;">
           <!-- Threads will be loaded here -->
        </div>

        <!-- New Thread Input Area -->
        <div class="mt-4 pt-4 border-t border-gray-200">
           <textarea id="newThreadInput" placeholder="Start a new discussion..." class="w-full p-2 border rounded mb-2 text-sm" rows="2"></textarea>
           <div class="flex justify-end">
             <button id="postThreadBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">Post Thread</button>
           </div>
        </div>
      </div>

  </div>
</section>

<!-- ✅ Events & Networking -->
<section id="events" class="py-12 px-6 bg-gray-900 text-gray-100 fade-in">
  <div class="max-w-5xl mx-auto">
    <h3 class="text-2xl font-bold mb-2">Events & Networking</h3>
    <p class="text-gray-400 mb-6">
      A platform to stay connected through reunions, alumni gatherings, and networking events. 
      Engage with your peers and build lifelong professional connections.
    </p>
    <hr class="border-gray-700 mb-6" />
    <button class="mb-6 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg shadow">
      + Create Event
    </button>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h4 class="text-xl font-semibold text-white">Annual Reunion 2025</h4>
        <p class="text-sm mt-2 text-gray-300">
          Join your batchmates for a grand reunion on campus and relive cherished memories together!
        </p>
        <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">
          RSVP
        </button>
      </div>
    </div>
  </div>
</section>

<!-- ✅ Mentorship & Career Support -->
<section id="mentorship" class="max-w-5xl mx-auto py-12 px-6 fade-in">
  <h3 class="text-2xl font-bold mb-2">Mentorship & Career Support</h3>
  <p class="text-gray-400 mb-6">
    Our mentorship program helps alumni guide students and junior graduates in their career journey. 
    Share experiences, provide advice, and empower the next generation.
  </p>
  <hr class="border-gray-700 mb-6" />
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
      <h4 class="text-xl font-semibold text-white">Become a Mentor</h4>
      <p class="mt-2 text-sm text-gray-300">
        Volunteer to guide students and junior alumni in their career paths, helping them succeed and grow.
      </p>
      <button class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow">
        Sign Up
      </button>
    </div>
  </div>
</section>


<section id="donations" class="bg-gray-900 py-12 px-6 fade-in">
  <div class="max-w-5xl mx-auto text-center">
    <h3 class="text-2xl font-bold mb-6 border-b pb-2 text-white">Fundraising & Donations</h3>
    <div class="bg-gray-800 p-8 rounded-xl shadow-lg">
      <p class="text-sm text-gray-300">
        Contribute to scholarships, infrastructure, and innovation at your alma mater.  
        Every donation directly supports student success and campus development.  
        Track your impact with transparent reports and project updates.
      </p>
      <button class="mt-6 bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition transform hover:scale-105">
        💜 Donate Now
      </button>
      <p class="mt-3 text-xs text-gray-400">Your generosity fuels the next generation of leaders.</p>
    </div>
  </div>
</section>



  <footer class="text-center py-6 bg-blue-600 text-white fade-in">
    <p>&copy; 2025 Alumni Connect | Built with ❤ for SIH</p>
  </footer>

  <!-- REDESIGNED: Chat Panel (Slide-in from right) -->
  <div id="chat-panel-container" class="fixed inset-0 bg-black bg-opacity-50 z-70 opacity-0 pointer-events-none">
    <div id="chat-panel" class="bg-white absolute top-0 right-0 h-full w-full max-w-2xl flex flex-col shadow-2xl">
      <!-- Panel Header -->
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">Messenger</h3>
        <button id="closeChatPanelBtn" class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      
      <!-- Panel Body -->
      <div class="flex flex-1 overflow-hidden">
        <!-- Left Pane: User List -->
        <div class="w-1/3 border-r flex flex-col">
          <div class="p-3 border-b">
            <input id="chatUserSearch" placeholder="Search alumni to chat..." class="w-full p-2 border rounded-lg text-sm" />
          </div>
          <div id="chatUserList" class="flex-1 space-y-1 p-2 overflow-y-auto">
            <!-- User search results will appear here -->
          </div>
        </div>
        
        <!-- Right Pane: Chat Window -->
        <div id="chatWindow" class="w-2/3 flex flex-col">
          <div id="chatWelcomeScreen" class="flex-1 flex flex-col items-center justify-center text-center p-6 text-gray-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
              <h4 class="font-semibold text-lg">Welcome to Alumni Messenger</h4>
              <p class="text-sm">Search for an alumnus or select a conversation to get started.</p>
          </div>
          <div id="chatActiveScreen" class="hidden flex-1 flex-col">
            <!-- Chat Header -->
            <div id="chatHeader" class="p-3 border-b flex items-center gap-3">
               <!-- Active chat user info here -->
            </div>
            <!-- Messages -->
            <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50">
              <!-- Messages will be loaded here -->
            </div>
            <!-- Message Input -->
            <div class="p-4 border-t bg-white">
              <div class="flex items-center gap-3">
                <input id="chatMessageInput" placeholder="Type a message..." class="flex-1 p-2.5 border rounded-lg" />
                <button id="sendChatBtn" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- 1. SUPABASE CLIENT SETUP ---
    const supabaseUrl = 'https://oriswzmkjvyesqlrpbya.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yaXN3em1ranZ5ZXNxbHJwYnlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MzA4OTMsImV4cCI6MjA3MzUwNjg5M30.YH3JEbMDL0r8FvmQ-KJtrKCVmJo5RslUKq90FkICvAE';
    const { createClient } = supabase;
    const _supabase = createClient(supabaseUrl, supabaseKey);



    // --- 2. LOAD ALUMNI DIRECTORY ---
    async function loadAlumni() {
      const { data, error } = await _supabase
        .from('alumni')
        .select('*');

      if (error) {
        console.error('Error loading alumni:', error);
        return;
      }

      const container = document.querySelector('#directory .grid');
      container.innerHTML = ''; // Clear existing content

      data.forEach(alumni => {
        container.innerHTML += `
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <img src="https://via.placeholder.com/100" alt="profile" class="w-20 h-20 rounded-full mb-3" />
            <h4 class="text-lg font-semibold">${alumni.name}</h4>
            <p class="text-sm text-gray-500">Batch: ${alumni.batch || 'N/A'} | Dept: ${alumni.dept || 'N/A'}</p>
            <p class="text-sm mt-2">${alumni.role || 'Role not specified'} @ ${alumni.company || 'Company not specified'}</p>
          </div>
        `;
      });
    }



    // --- 3. HANDLE ALUMNI REGISTRATION ---
    document.getElementById('alumni-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Reliably get data using IDs
      const formData = {
        name: document.getElementById('alumni-name').value,
        email: document.getElementById('alumni-email').value,
        batch: document.getElementById('alumni-batch').value,
        dept: document.getElementById('alumni-dept').value,
        role: document.getElementById('alumni-role').value,
        company: document.getElementById('alumni-company').value,
        location: document.getElementById('alumni-location').value,
      };

      const { data, error } = await _supabase
        .from('alumni')
        .insert([formData]);

      if (error) {
        console.error('Insert error:', error);
        alert('Failed to register alumni. Please check the console for details.');
      } else {
        alert('Alumni registered successfully!');
        document.getElementById('alumni-form').reset(); // Clear the form
        loadAlumni(); // Reload the directory with the new entry
      }
    });



    // --- 4. DARK MODE & SCROLL ANIMATION ---
    const toggle = document.getElementById('darkModeToggle');
    const body = document.body;
    toggle.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      toggle.textContent = body.classList.contains('dark-mode') ? "☀ Light Mode" : "🌙 Dark Mode";
    });

    const fadeElems = document.querySelectorAll('.fade-in');
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
        }
      });
    }, { threshold: 0.1 });
    fadeElems.forEach(el => observer.observe(el));



    // --- 5. INITIALIZE PAGE ---
    // We will not call loadAlumni() on DOMContentLoaded anymore to protect data.
    // document.addEventListener('DOMContentLoaded', loadAlumni);
  </script>

  <script>
    // ========== NOTES ==========
    // This script block has been updated with new UI logic for the redesigned
    // messenger and forums.
    // ===========================

    // reuse the same supabase client _supabase from original script
    if (typeof _supabase === 'undefined') {
      const { createClient } = supabase;
      window._supabase = createClient(supabaseUrl, supabaseKey);
    }

    // --- UTILS ---
    function el(selector) { return document.querySelector(selector); }
    function els(selector) { return Array.from(document.querySelectorAll(selector)); }

    // --- DIRECTORY SEARCH LOGIC (largely unchanged) ---
    const directorySearchInput = el('#directory input[type="text"]');
    const directoryGrid = el('#directory .grid');
    const directorySearchBtn = el('#directorySearchBtn');
    const clearSearchBtn = el('#clearSearchBtn');

    function showDirectoryResults(cardsHtml) {
      directoryGrid.style.display = 'grid';
      directoryGrid.innerHTML = cardsHtml || '<div class="col-span-3 bg-white p-6 rounded-xl shadow-lg">No results found.</div>';
    }
    function hideDirectoryResults() {
      directoryGrid.style.display = 'none';
      directoryGrid.innerHTML = '';
    }
    hideDirectoryResults();

    async function searchAlumni(query) {
      if (!query || query.trim().length === 0) {
        alert('Enter a search term (name, batch, department, company or location).');
        return;
      }
      const q = query.trim();
      const { data, error } = await _supabase
        .from('alumni')
        .select('id, name, batch, dept, role, company, location, email')
        .or(name.ilike.%${q}%,batch.ilike.%${q}%,dept.ilike.%${q}%,company.ilike.%${q}%,location.ilike.%${q}%)
        .limit(50);

      if (error) {
        console.error('Search error:', error);
        alert('Search failed — check console for details.');
        return;
      }

      if (!data || data.length === 0) {
        showDirectoryResults('<div class="col-span-3 bg-white p-6 rounded-xl shadow-lg">No matching alumni found.</div>');
        return;
      }

      const cards = data.map(alumni => `
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <img src="https://via.placeholder.com/100" alt="profile" class="w-20 h-20 rounded-full mb-3" />
          <h4 class="text-lg font-semibold">${escapeHtml(alumni.name || 'Unknown')}</h4>
          <p class="text-sm text-gray-500">Batch: ${escapeHtml(alumni.batch || 'N/A')} | Dept: ${escapeHtml(alumni.dept || 'N/A')}</p>
          <p class="text-sm mt-2">${escapeHtml(alumni.role || 'Role not specified')} @ ${escapeHtml(alumni.company || 'Company not specified')}</p>
          <p class="text-sm mt-3 text-gray-700"><strong>Location:</strong> ${escapeHtml(alumni.location || '—')}</p>
          <div class="mt-3 flex gap-2">
            <button class="openProfileBtn px-3 py-1 bg-blue-600 text-white rounded" data-id="${alumni.id}" data-name="${escapeHtml(alumni.name || '')}">View / Message</button>
            <button class="connectBtn px-3 py-1 bg-green-600 text-white rounded" data-id="${alumni.id}">Connect</button>
          </div>
        </div>
      `).join('');

      showDirectoryResults(cards);

      els('.openProfileBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          const name = btn.getAttribute('data-name');
          openChatWithUserIdFromSearch(id, name);
        });
      });

      els('.connectBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          alert('Connect request UI placeholder — backend invite/connection logic can be implemented next.');
        });
      });
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    directorySearchBtn.addEventListener('click', () => searchAlumni(directorySearchInput.value));
    directorySearchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchAlumni(directorySearchInput.value);
      }
    });
    clearSearchBtn.addEventListener('click', () => {
      directorySearchInput.value = '';
      hideDirectoryResults();
    });

    // --- AUTH UI + FLOWS (unchanged) ---
    const openAuthBtn = document.getElementById('openAuthBtn');
    const authStatusEl = document.getElementById('auth-status');
    const authModalHtml = `
      <div id="authOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-60 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
          <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Sign in / Sign up</h3><button id="closeAuth" class="text-gray-600">✕</button></div>
          <div class="grid md:grid-cols-2 gap-4">
            <div><h4 class="font-semibold mb-2">Create account</h4><input id="signupEmail" type="email" placeholder="Email" class="w-full p-2 border rounded mb-2" /><input id="signupPassword" type="password" placeholder="Password" class="w-full p-2 border rounded mb-2" /><button id="signupBtn" class="w-full bg-blue-600 text-white py-2 rounded">Create account</button></div>
            <div><h4 class="font-semibold mb-2">Sign in</h4><input id="signinEmail" type="email" placeholder="Email" class="w-full p-2 border rounded mb-2" /><input id="signinPassword" type="password" placeholder="Password" class="w-full p-2 border rounded mb-2" /><button id="signinBtn" class="w-full bg-green-600 text-white py-2 rounded">Sign in</button><button id="magicLinkBtn" class="w-full mt-2 bg-gray-200 text-gray-800 py-2 rounded">Send magic link</button></div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', authModalHtml);
    const authOverlay = document.getElementById('authOverlay');
    document.getElementById('closeAuth').addEventListener('click', () => { authOverlay.classList.add('hidden'); });
    openAuthBtn.addEventListener('click', () => { authOverlay.classList.remove('hidden'); });
    document.getElementById('signupBtn').addEventListener('click', async () => {
      const email = document.getElementById('signupEmail').value, password = document.getElementById('signupPassword').value; if (!email || !password) { alert('Enter email & password'); return; }
      const { error } = await _supabase.auth.signUp({ email, password }); if (error) { console.error('Sign up error', error); alert('Sign up failed — check console.'); return; }
      alert('Sign up initiated. Check email for confirmation.'); authOverlay.classList.add('hidden'); refreshAuthState();
    });
    document.getElementById('signinBtn').addEventListener('click', async () => {
      const email = document.getElementById('signinEmail').value, password = document.getElementById('signinPassword').value; if (!email || !password) { alert('Enter email & password'); return; }
      const { error } = await _supabase.auth.signInWithPassword({ email, password }); if (error) { console.error('Sign in error', error); alert('Sign in failed — check console.'); return; }
      alert('Signed in!'); authOverlay.classList.add('hidden'); refreshAuthState();
    });
    document.getElementById('magicLinkBtn').addEventListener('click', async () => {
      const email = document.getElementById('signinEmail').value || document.getElementById('signupEmail').value; if (!email) { alert('Enter email for magic link'); return; }
      const { error } = await _supabase.auth.signInWithOtp({ email }); if (error) { console.error('Magic link error', error); alert('Failed to send magic link.'); return; }
      alert('Magic link sent to email.');
    });
    async function refreshAuthState() {
      const { data: { user } } = await _supabase.auth.getUser();
      if (user) {
        authStatusEl.textContent = Signed in as ${user.email}; authStatusEl.classList.remove('hidden'); openAuthBtn.textContent = 'Account';
        if (!document.getElementById('logoutBtn')) {
          const logoutBtn = document.createElement('button'); logoutBtn.id = 'logoutBtn'; logoutBtn.className = 'px-3 py-1 bg-white text-blue-600 rounded hover:opacity-90'; logoutBtn.textContent = 'Logout';
          logoutBtn.addEventListener('click', async () => { await _supabase.auth.signOut(); refreshAuthState(); alert('Signed out.'); });
          openAuthBtn.insertAdjacentElement('afterend', logoutBtn);
        }
      } else {
        authStatusEl.textContent = 'Not signed in'; openAuthBtn.textContent = 'Sign up / Log in'; document.getElementById('logoutBtn')?.remove();
      }
    }
    _supabase.auth.onAuthStateChange(refreshAuthState);

    // --- REDESIGNED: MESSAGING (SLIDE-IN PANEL) ---
    const openChatModalBtn = el('#openChatModalBtn');
    const closeChatPanelBtn = el('#closeChatPanelBtn');
    const chatPanelContainer = el('#chat-panel-container');
    const chatUserList = el('#chatUserList');
    const chatUserSearch = el('#chatUserSearch');
    const chatMessages = el('#chatMessages');
    const chatMessageInput = el('#chatMessageInput');
    const sendChatBtn = el('#sendChatBtn');
    const chatWelcomeScreen = el('#chatWelcomeScreen');
    const chatActiveScreen = el('#chatActiveScreen');
    const chatHeader = el('#chatHeader');

    let currentChatUserId = null;
    let currentUser = null;
    const messagesSubscriptionRefs = [];

    function showChatPanel() {
        chatPanelContainer.classList.add('visible');
    }
    function hideChatPanel() {
        chatPanelContainer.classList.remove('visible');
    }

    openChatModalBtn.addEventListener('click', showChatPanel);
    closeChatPanelBtn.addEventListener('click', hideChatPanel);
    chatPanelContainer.addEventListener('click', (e) => {
        // Close if the dark overlay is clicked, but not the panel itself
        if (e.target === chatPanelContainer) {
            hideChatPanel();
        }
    });

    chatUserSearch.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;
      const q = chatUserSearch.value.trim();
      if (!q) return;
      const { data, error } = await _supabase.from('alumni').select('id, name, email, batch, dept').or(name.ilike.%${q}%,email.ilike.%${q}%).limit(30);
      if (error) { console.error(error); chatUserList.innerHTML = '<div class="text-red-600 p-3">Search failed</div>'; return; }
      if (!data || data.length === 0) { chatUserList.innerHTML = '<div class="text-sm text-gray-600 p-3">No users found</div>'; return; }

      chatUserList.innerHTML = data.map(u => `
        <div class="flex items-center gap-3 chat-user-item-list" data-id="${u.id}" data-name="${escapeHtml(u.name || '')}">
          <img src="https://via.placeholder.com/40" class="w-10 h-10 rounded-full" alt="avatar" />
          <div>
            <div class="font-semibold text-sm">${escapeHtml(u.name || '(no name)')}</div>
            <div class="text-xs text-gray-500">${escapeHtml(u.batch || '—')} • ${escapeHtml(u.dept || '—')}</div>
          </div>
        </div>
      `).join('');

      els('.chat-user-item-list').forEach(item => {
        item.addEventListener('click', () => {
          const id = item.getAttribute('data-id');
          const name = item.getAttribute('data-name');
          openChatWithUserId(id, name);
        });
      });
    });

    async function openChatWithUserId(userId, userName) {
        currentChatUserId = userId;
        chatWelcomeScreen.classList.add('hidden');
        chatActiveScreen.classList.remove('hidden');
        chatActiveScreen.classList.add('flex');
        chatHeader.innerHTML = <img src="https://via.placeholder.com/40" class="w-10 h-10 rounded-full" /><div class="font-semibold">${escapeHtml(userName)}</div>;
        chatMessages.innerHTML = '<div class="text-sm text-gray-600">Loading messages...</div>';

        const { data: authData } = await _supabase.auth.getUser();
        currentUser = authData?.user || null;

        if (!currentUser) {
            chatMessages.innerHTML = '<div class="p-4 text-sm text-yellow-600">You must be signed in to view and send messages.</div>';
            return;
        }
        
        const { data: msgs, error } = await _supabase.from('messages').select('*').or(and(from_id.eq.${currentUser.id},to_id.eq.${userId}),and(from_id.eq.${userId},to_id.eq.${currentUser.id})).order('inserted_at', { ascending: true }).limit(200);

        if (error) {
            console.warn('Could not load messages:', error);
            chatMessages.innerHTML = '<div class="text-sm text-gray-600 p-4">No messages available (table may not exist).</div>';
            return;
        }

        renderMessages(msgs || []);
        
        // Setup realtime subscription
        messagesSubscriptionRefs.forEach(channel => _supabase.removeChannel(channel));
        messagesSubscriptionRefs.length = 0;

        const channel = _supabase.channel(messages:${currentUser.id}:${userId}).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
            const newMsg = payload.new;
            if (!newMsg) return;
            const relevant = (newMsg.from_id == currentUser.id && newMsg.to_id == userId) || (newMsg.from_id == userId && newMsg.to_id == currentUser.id);
            if (relevant) appendMessageToChat(newMsg, newMsg.from_id == currentUser.id ? 'me' : 'them');
        }).subscribe();
        messagesSubscriptionRefs.push(channel);
    }
    
    function renderMessages(msgs) {
      chatMessages.innerHTML = '';
      if (!msgs || msgs.length === 0) {
        chatMessages.innerHTML = '<div class="text-sm text-center text-gray-500 p-4">No messages yet. Start the conversation!</div>';
        return;
      }
      msgs.forEach(m => appendMessageToChat(m, (m.from_id == currentUser?.id) ? 'me' : 'them'));
    }

    function appendMessageToChat(m, who) {
      if (chatMessages.innerHTML.includes('No messages yet')) chatMessages.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = message ${who};
      wrap.innerHTML = <p>${escapeHtml(m.content)}</p>;
      chatMessages.appendChild(wrap);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage() {
        const content = chatMessageInput.value.trim();
        if (!content || !currentChatUserId || !currentUser) return;
        const payload = { from_id: currentUser.id, to_id: currentChatUserId, content };
        const { error } = await _supabase.from('messages').insert([payload]);
        if (error) { console.error('Send error:', error); alert('Failed to send message.'); return; }
        chatMessageInput.value = '';
    }
    sendChatBtn.addEventListener('click', sendMessage);
    chatMessageInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }});

    // --- NEW: FORUMS (TAB-BASED) ---
    const forumTabs = els('.forum-tab');
    const forumThreads = el('#forumThreads');
    const postThreadBtn = el('#postThreadBtn');
    const newThreadInput = el('#newThreadInput');
    let activeForum = 'general';

    async function loadForumThreads(forum) {
        activeForum = forum;
        forumTabs.forEach(tab => {
            tab.classList.toggle('active', tab.dataset.forum === forum);
        });

        forumThreads.innerHTML = '<p class="text-gray-500">Loading threads...</p>';
        const { data, error } = await _supabase.from('forum_threads').select('*, author:alumni(name)').eq('forum', forum).order('inserted_at', { ascending: false }).limit(50);
        
        if (error) {
            forumThreads.innerHTML = <div class="p-3 border rounded bg-yellow-50 text-yellow-700">Could not load threads (table may not exist).</div>;
            return;
        }
        if (!data || data.length === 0) {
            forumThreads.innerHTML = <div class="p-3 border rounded text-gray-600">No threads in <strong>${escapeHtml(forum)}</strong> yet. Be the first to post!</div>;
            return;
        }
        forumThreads.innerHTML = data.map(t => `
          <div class="p-3 border rounded-lg">
            <p class="text-gray-800">${escapeHtml(t.body || '')}</p>
            <div class="text-xs text-gray-500 mt-2">Posted by <strong>${escapeHtml(t.author?.name || 'Anonymous')}</strong> on ${new Date(t.inserted_at).toLocaleDateString()}</div>
          </div>
        `).join('');
    }
    
    forumTabs.forEach(tab => tab.addEventListener('click', () => loadForumThreads(tab.dataset.forum)));

    postThreadBtn.addEventListener('click', async () => {
        const body = newThreadInput.value.trim();
        if (!body) { alert('Enter thread content.'); return; }
        const { data: authData } = await _supabase.auth.getUser();
        if (!authData.user) { alert('Sign in to post threads.'); return; }

        const payload = { forum: activeForum, body, author_id: authData.user.id };
        const { error } = await _supabase.from('forum_threads').insert([payload]);
        if (error) {
            console.error('Forum post error:', error);
            alert('Failed to post thread.');
            return;
        }
        newThreadInput.value = '';
        alert('Thread posted!');
        loadForumThreads(activeForum); // Refresh view
    });

    // --- FINAL INITIALIZATION ---
    function openChatWithUserIdFromSearch(userId, userName) {
      const networkingSection = document.getElementById('networking');
      if (networkingSection) networkingSection.scrollIntoView({ behavior: 'smooth' });
      showChatPanel();
      openChatWithUserId(userId, userName);
    }

    // --- ADDED: ALUMNI SHOWCASE LOGIC ---
    function populateAlumniShowcase() {
      const showcaseAlumniData = [
        { name: 'Dr. Evelyn Reed', qualification: 'Ph.D. in Astrophysics', college: 'Stellar University', post: 'Lead Research Scientist', company: 'Galaxy Explorations Inc.', avatar: 'https://placehold.co/100x100/a3e635/1e3a8a?text=ER' },
        { name: 'Marcus Chen', qualification: 'M.S. in Computer Science', college: 'Tech Institute of Innovation', post: 'Senior AI Engineer', company: 'Nexus AI', avatar: 'https://placehold.co/100x100/67e8f9/1e3a8a?text=MC' },
        { name: 'Aisha Khan', qualification: 'MBA, Finance', college: 'Global Business School', post: 'Investment Banking VP', company: 'Quantum Capital', avatar: 'https://placehold.co/100x100/f9a8d4/1e3a8a?text=AK' },
        { name: 'Leo Martinez', qualification: 'B.A. in Journalism', college: 'Chronicle College', post: 'Investigative Journalist', company: 'The Daily Truth', avatar: 'https://placehold.co/100x100/fde047/1e3a8a?text=LM' },
        { name: 'Dr. Samuel Greene', qualification: 'M.D. in Cardiology', college: 'Healers Medical University', post: 'Chief of Cardiology', company: 'Unity General Hospital', avatar: 'https://placehold.co/100x100/fca5a5/1e3a8a?text=SG' }
      ];

      const slider = el('#showcase-slider-content');
      if (!slider) return;

      const cardHtml = showcaseAlumniData.map(alumni => `
        <div class="alumni-card bg-white p-6 rounded-xl shadow-lg mx-4 flex flex-col items-center text-center">
            <img src="${alumni.avatar}" alt="${alumni.name}" class="w-24 h-24 rounded-full mb-4 border-4 border-indigo-200" />
            <h4 class="text-xl font-semibold text-gray-900">${alumni.name}</h4>
            <p class="text-indigo-600 font-semibold text-sm">${alumni.post}</p>
            <p class="text-gray-500 text-sm mb-3">@ ${alumni.company}</p>
            <p class="text-gray-700 text-xs mt-2 flex-grow">
              <strong>${alumni.qualification}</strong> from ${alumni.college}
            </p>
        </div>
      `).join('');

      // Duplicate the cards for a seamless infinite scroll effect
      slider.innerHTML = cardHtml + cardHtml;
      
      // Dynamically set animation duration based on 7 seconds per card
      const totalDuration = showcaseAlumniData.length * 7;
      slider.style.animationDuration = ${totalDuration}s;
    }


    document.addEventListener('DOMContentLoaded', () => {
      refreshAuthState();
      loadForumThreads('general'); // Load default forum on page load
      populateAlumniShowcase(); // ADDED: Populate the new showcase
    });

  </script>
</body>
</html>
